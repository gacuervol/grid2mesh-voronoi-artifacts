#!/usr/bin/env bash
set -euo pipefail

# ==========================================================
#  Experimental setup: Mesh resolution vs Grid coverage
# ==========================================================
#
# We will run a battery of experiments to analyze how the
# mesh resolution (N_mesh) affects the grid-to-mesh ratio.
#
# The reference grid has 90,000 nodes, and for each experiment
# we compute:
#
#     Grid / mesh = 90,000 / N_mesh
#
# The experiments are:
#
#   Exp | N_mesh | Grid / mesh
#   ----+--------+-------------
#     1 |     25 |     3600.000
#     2 |     40 |     2250.000
#     3 |     65 |     1384.615
#     4 |    105 |      857.143
#     5 |    170 |      529.412
#     6 |    275 |      327.273
#
# ----------------------------------------------------------
# Rationale:
#
# - As the number of mesh nodes increases, the number of grid
#   nodes covered by a single mesh node (Grid/mesh ratio)
#   naturally decreases.
#
# - Ideally, this decrease should follow a geometric sequence,
#   with a reduction factor between 1.5 and 2 at each step.
#
# - To guide this progression, we use the golden ratio (phi),
#   approximately 1.618, which lies in the desired range.
#
# - This ensures that between successive experiments, the
#   number of grid nodes per mesh node decreases smoothly
#   by a factor close to phi.
#
# ----------------------------------------------------------
# Goal:
#
# These experiments will help us evaluate the sensitivity of
# the simulation results to mesh resolution, ensuring that
# the mesh is refined in a controlled and systematic way.
#
# ==========================================================

# ----------------------------
# Hyperparameters:

epochs=150
sanity_check="false"

# ==========================================================
#  Note on uniform square meshes
# ==========================================================
#
# For uniform meshes (square grids), we cannot directly use
# the exact N_mesh values defined above.
#
# Reason:
# - Square meshes must be defined using perfect squares
#   (k^2), since the mesh is constructed as a regular
#   k x k grid.
#
# - Therefore, instead of the exact N_mesh values, we select
#   the closest perfect squares:
#
#     Target   →   Adjusted (closest perfect square)
#     -------      -------------------------------
#       25    →   5^2
#       40    →   6.3^2 ≈ 6^2
#       65    →   8^2
#      105    →   10.2^2 ≈ 10^2
#      170    →   13^2 *
#      275    →   16.6^2 ≈ 17^2
#
# - The case marked with an asterisk (*) was not executed.
#   Specifically, N_mesh ≈ 13^2 caused issues with the node
#   elimination algorithm (which removes mesh nodes located
#   over land). The algorithm appeared to fail for this
#   configuration, so we excluded it from the experiments.
#
# ----------------------------------------------------------
# In summary:
# - Uniform meshes are constrained to perfect-square sizes.
# - Small adjustments were made to map the theoretical N_mesh
#   sequence to feasible square mesh sizes.
# - One problematic case (13^2) was skipped due to algorithmic
#   instability.
#
# ==========================================================

# ----------------------------

# EXPERIMENTS CROSSING EDGES

# ----------------------------
exp_name="crossing_edges"
# crossing_edges options: 1 (crossing edges) or 0 (non-crossing edges)
crossing_edges=1
# mesh_type options: "uniform", "bathymetry", "fps"
mesh_type="uniform"
# ----------------------------

# Experimento 1
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="5, 4"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 2
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="6, 4"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 3
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="8, 6"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 4
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="10, 7"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# # ----------------------------
# # Experimento 5
# # Parameters:
# # If uniform the number of nodes m,n is implicit mxm, nxn
# # If bathymetry the number of nodes is explicit m, n
# mesh_nodes="13, 9"
# g2m_m2g_conect=4
# # ----------------------------
# # This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
# ./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
# last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
# printf "%s\n" "$last_dir_name"
# ./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 6
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="17, 12"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda
# ----------------------------

# EXPERIMENTS NON CROSSING EDGES

# ----------------------------
exp_name="non_crossing_edges"
# crossing_edges options: 1 (crossing edges) or 0 (non-crossing edges)
crossing_edges=0
# mesh_type options: "uniform", "bathymetry"
mesh_type="uniform"

# ----------------------------
# Experimento 1
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="5, 4"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 2
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="6, 4"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 3
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="8, 6"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 4
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="10, 7"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# # ----------------------------
# # Experimento 5
# # Parameters:
# # If uniform the number of nodes m,n is implicit mxm, nxn
# # If bathymetry the number of nodes is explicit m, n
# mesh_nodes="13, 9"
# g2m_m2g_conect=4
# # ----------------------------
# # This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
# ./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
# last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
# printf "%s\n" "$last_dir_name"
# ./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda

# ----------------------------
# Experimento 6
# Parameters:
# If uniform the number of nodes m,n is implicit mxm, nxn
# If bathymetry the number of nodes is explicit m, n
mesh_nodes="17, 12"
g2m_m2g_conect=4
# ----------------------------
# This script creates a hierarchical mesh with non-crossing edges guided by bathymetry and trains a model on it.
./seacast_cli/bin/seacast train -s ${sanity_check} -e ${epochs} -n ${exp_name} -m ${mesh_type} -o "${mesh_nodes}" -c ${g2m_m2g_conect} -x ${crossing_edges}
last_dir_name=$(basename "$(ls -td ${HOME}/Seacast/saved_models/*/ | head -n 1)")
printf "%s\n" "$last_dir_name"
./seacast_cli/bin/seacast predict -s ${sanity_check} -c ${last_dir_name} -d cuda
